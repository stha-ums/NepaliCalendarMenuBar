name: Update Metadata Only

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update_metadata:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Commit Message
        id: check_msg
        run: |
          # Check if manual dispatch
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse commit message
          MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $MSG"
          
          if [[ "$MSG" == "chore(store):"* ]]; then
             echo "should_run=true" >> $GITHUB_OUTPUT
             echo "Detected chore(store): -> Updating metadata"
          else
             echo "should_run=false" >> $GITHUB_OUTPUT
             echo "No metadata trigger found."
          fi

      - name: Setup Fastlane
        if: steps.check_msg.outputs.should_run == 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Upload Metadata
        if: steps.check_msg.outputs.should_run == 'true'
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_DEPLOY_KEY: ${{ secrets.MATCH_DEPLOY_KEY }}
          FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY }}
        run: |
          # Setup SSH for Match
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_DEPLOY_KEY }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          bundle exec fastlane upload_metadata
